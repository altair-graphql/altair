name: pr-workflow

on:
  push:
    branches:
      - master
    tags:
      - '**'
  pull_request:
  workflow_dispatch:

# v*.*.*

env:
  NODE_VERSION: 18
  # NODE_OPTIONS: --openssl-legacy-provider

jobs:
  vars:
    runs-on: ubuntu-latest
    outputs:
      node_version: ${{ env.NODE_VERSION }}
    steps:
      - run: echo "Exposing env vars"
  deploy-docs:
    name: Deploy docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.1
      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: ${{ env.NODE_VERSION }}
      - run: yarn --frozen-lockfile --network-timeout 1000000
        env:
          GITHUB_TOKEN: ${{ github.token }}
          NODE_OPTIONS: '--max_old_space_size=4096' # Getting Javascript heap out of memory error. Increasing heap size
      # https://developers.cloudflare.com/pages/how-to/use-direct-upload-with-continuous-integration/#use-github-actions
      # TODO: Make this reusable
      - run: |
          export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
          export CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          cd packages/altair-docs
          npx wrangler@2 pages publish ".vitepress/dist" --project-name="altair-site"
      - run: |
          export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
          export CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          cd packages/login-redirect
          npx wrangler@2 pages publish "dist" --project-name="altair-login-redirect"
      - run: |
          export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
          export CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          cd packages/altair-iframe-sandbox
          npx wrangler@2 pages publish "dist" --project-name="altair-iframe-sandbox"
  test:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        node-version: [16]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Use Node.js ${{ env.NODE_VERSION }} on ${{ matrix.os }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: nrwl/nx-set-shas@v2
        with:
          main-branch-name: master
      # - name: restore lerna
      #   uses: actions/cache@v2
      #   with:
      #     path: |
      #       node_modules
      #       */*/node_modules
      #     key: ${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - run: yarn --frozen-lockfile --network-timeout 1000000
      - uses: browser-actions/setup-chrome@latest
      - name: Build apps (with retries)
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: yarn build:ci
      - name: Run headless test
        uses: GabrielBB/xvfb-action@v1
        with:
          run: yarn test:ci:retries
          # run: |
          #   (echo "===== Headless Tests Attempt: 1 ====" && yarn test:ci) || \
          #   (echo "===== Headless Tests Attempt: 2 ====" && yarn test:ci) || \
          #   (echo "===== Headless Tests Attempt: 3 ====" && yarn test:ci) || \
          #   (echo "==== Headless Tests Step Failed ====" && exit 1)
      # https://github.com/tanshuai/electron-playwright-e2e-test-quick-start/blob/1e2c653bc2d0af85d98de1c58e56a888f17fe671/.github/workflows/ci.yml#L39-L44
      - name: Upload Test Results ðŸ—ƒ
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: screenshots
          path: packages/altair-electron/e2e/*.png
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          push: false

  electron:
    needs: vars
    uses: ./.github/workflows/reusable-publish-electron.yml
    with:
      node_version: ${{ needs.vars.outputs.node_version }}
      publish: false
      # TODO: publish/build?: ${{!(startsWith(matrix.os, 'macos') && github.ref != 'refs/heads/master')}} # disable for macos not in master branch
    secrets: inherit
